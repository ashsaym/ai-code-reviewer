name: Code Sentinel AI - Documentation Generation

on:
  workflow_dispatch:
    inputs:
      documentation_scope:
        description: 'Documentation Scope'
        type: choice
        required: false
        options:
          - full
          - api-only
          - guide-only
          - architecture
          - minimal
        default: full
      
      documentation_depth:
        description: 'Documentation Detail Level'
        type: choice
        required: false
        options:
          - minimal
          - standard
          - detailed
          - comprehensive
        default: standard
      
      include_diagrams:
        description: 'Include Architecture Diagrams'
        type: boolean
        default: true
      
      include_examples:
        description: 'Include Code Examples'
        type: boolean
        default: true
      
      include_dependencies:
        description: 'Include Dependency Analysis'
        type: boolean
        default: true

permissions:
  contents: read
  checks: write

jobs:
  documentation:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Build Action
        run: |
          cd code-sentinel-ai
          npm ci
          npm run build
      
      - name: Generate Documentation
        id: docs
        uses: ./code-sentinel-ai
        with:
          mode: documentation
          documentation-scope: ${{ inputs.documentation_scope }}
          documentation-formats: 'markdown,html'
          documentation-output-dir: './docs-generated'
          doc-depth: ${{ inputs.documentation_depth }}
          doc-include-diagrams: ${{ inputs.include_diagrams }}
          doc-include-examples: ${{ inputs.include_examples }}
          doc-include-dependencies: ${{ inputs.include_dependencies }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-5-mini'
          max-tokens: '128000'
          timeout: '600000'  # 10 minutes
      
      - name: Upload Documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: project-documentation-${{ inputs.documentation_scope }}
          path: docs-generated/
          retention-days: 90
      
      - name: Display Documentation Summary
        if: always()
        run: |
          echo "=== Documentation Summary ==="
          echo "Scope: ${{ inputs.documentation_scope }}"
          echo "Sections: ${{ steps.docs.outputs.sections-count }}"
          echo "Words: ${{ steps.docs.outputs.words-count }}"
          
          if [ -d "docs-generated" ]; then
            echo ""
            echo "=== Generated Files ==="
            find docs-generated -type f | head -20
          fi
  
  summary:
    runs-on: ubuntu-latest
    needs: [documentation]
    if: always()
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
      
      - name: Generate Pipeline Summary
        run: |
          echo "# ðŸ“š Documentation Generation Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **Scope:** ${{ inputs.documentation_scope }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Depth:** ${{ inputs.documentation_depth }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Diagrams:** ${{ inputs.include_diagrams }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Examples:** ${{ inputs.include_examples }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dependencies:** ${{ inputs.include_dependencies }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Documentation available in workflow artifacts" >> $GITHUB_STEP_SUMMARY

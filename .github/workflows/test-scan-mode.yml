name: Test Scan Mode

on:
  workflow_dispatch:
    inputs:
      scan-type:
        description: 'Type of scan to perform'
        required: true
        default: 'all'
        type: choice
        options:
          - security
          - quality
          - documentation
          - architecture
          - all
      scan-scope:
        description: 'Scope of scan'
        required: false
        default: 'full-codebase'
        type: choice
        options:
          - full-codebase
          - src-only
          - dependencies
          - tests

jobs:
  test-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          cd code-sentinel-ai
          npm ci
          
      - name: Build action
        run: |
          cd code-sentinel-ai
          npm run build
          
      - name: Run Scan Mode
        uses: ./code-sentinel-ai
        with:
          mode: 'scan'
          scan-type: ${{ inputs.scan-type }}
          scan-scope: ${{ inputs.scan-scope }}
          max-scan-tokens: 100000
          publish-outputs: 'html,json,md'
          issue-threshold: 'high'
          scan-include-patterns: |
            src/**/*.ts
            lib/**/*.js
            config/**/*.json
          scan-exclude-patterns: |
            **/*.test.ts
            **/*.spec.js
            **/node_modules/**
            **/dist/**
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-5-mini'
          
      - name: Display Scan Results
        if: always()
        run: |
          echo "=== Scan Summary ==="
          if [ -f "scan-report.md" ]; then
            cat scan-report.md
          else
            echo "No markdown report generated"
          fi
          
      - name: Upload HTML Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: scan-report-html-${{ inputs.scan-type }}
          path: |
            scan-report.html
            scan-report.json
          retention-days: 30
          
      - name: Check for Critical Findings
        if: always()
        run: |
          if [ -f "scan-report.json" ]; then
            CRITICAL_COUNT=$(jq '.statistics.criticalIssues // 0' scan-report.json)
            HIGH_COUNT=$(jq '.statistics.highIssues // 0' scan-report.json)
            echo "Critical Issues: $CRITICAL_COUNT"
            echo "High Issues: $HIGH_COUNT"
            
            if [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "::warning::Found $CRITICAL_COUNT critical security issues!"
            fi
          fi
          
      - name: Verify Outputs
        run: |
          echo "=== Checking Action Outputs ==="
          echo "Success: ${{ steps.scan.outputs.success }}"
          echo "Findings Count: ${{ steps.scan.outputs.findings-count }}"
          echo "Critical Count: ${{ steps.scan.outputs.critical-count }}"
          echo "High Count: ${{ steps.scan.outputs.high-count }}"

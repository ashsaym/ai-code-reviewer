name: 'Test Code Sentinel AI'

on:
  pull_request:
    types: [opened, synchronize, reopened]
  
  # Allow manual trigger for testing
  workflow_dispatch:
    inputs:
      pr-number:
        description: 'PR number to review'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  code-review:
    runs-on: ubuntu-latest
    name: AI Code Review
    
    steps:
      - name: Checkout v2 branch
        uses: actions/checkout@v4
        with:
          ref: v2-rewrite
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: v2/package-lock.json
      
      - name: Install dependencies
        run: |
          cd v2
          npm ci
      
      - name: Build action
        run: |
          cd v2
          npm run build
      
      - name: Run Code Sentinel AI
        uses: ./v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-3.5-turbo'  # Using 3.5 for testing (cheaper)
          max-files-per-batch: 5
          auto-clean-outdated: true
          enable-check-runs: true
          debug-mode: true

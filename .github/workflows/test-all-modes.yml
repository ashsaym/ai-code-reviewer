name: Comprehensive Mode Testing

on:
  workflow_dispatch:
    inputs:
      test-suite:
        description: 'Which test suite to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - review-only
          - scan-only
          - documentation-only
          - comparison

jobs:
  test-review-mode:
    if: inputs.test-suite == 'all' || inputs.test-suite == 'review-only' || inputs.test-suite == 'comparison'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Build
        run: |
          cd code-sentinel-ai
          npm ci
          npm run build
          
      - name: Create Test PR (Mock)
        run: |
          echo "Simulating PR review scenario..."
          # In real scenario, this would be triggered by actual PR
          
      - name: Test Review Mode
        continue-on-error: true
        uses: ./code-sentinel-ai
        with:
          mode: 'review'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-4o'
          max-files-per-batch: 5
          
  test-scan-security:
    if: inputs.test-suite == 'all' || inputs.test-suite == 'scan-only'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Build
        run: |
          cd code-sentinel-ai
          npm ci
          npm run build
          
      - name: Security Scan
        id: security-scan
        uses: ./code-sentinel-ai
        with:
          mode: 'scan'
          scan-type: 'security'
          scan-scope: 'full-codebase'
          max-scan-tokens: 80000
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-4o'
          
      - name: Upload Security Report
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-report
          path: scan-report.*
          
  test-scan-quality:
    if: inputs.test-suite == 'all' || inputs.test-suite == 'scan-only'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Build
        run: |
          cd code-sentinel-ai
          npm ci
          npm run build
          
      - name: Quality Scan
        uses: ./code-sentinel-ai
        with:
          mode: 'scan'
          scan-type: 'quality'
          scan-scope: 'src-only'
          max-scan-tokens: 80000
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-4o'
          
      - name: Upload Quality Report
        uses: actions/upload-artifact@v4
        with:
          name: quality-scan-report
          path: scan-report.*
          
  test-documentation-full:
    if: inputs.test-suite == 'all' || inputs.test-suite == 'documentation-only'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Build
        run: |
          cd code-sentinel-ai
          npm ci
          npm run build
          
      - name: Generate Full Documentation
        uses: ./code-sentinel-ai
        with:
          mode: 'documentation'
          documentation-scope: 'full'
          documentation-formats: 'markdown,html'
          documentation-output-dir: './docs-full'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-4o'
          
      - name: Upload Documentation
        uses: actions/upload-artifact@v4
        with:
          name: full-documentation
          path: docs-full/
          
  test-comparison:
    if: inputs.test-suite == 'all' || inputs.test-suite == 'comparison'
    needs: [test-scan-security, test-scan-quality, test-documentation-full]
    runs-on: ubuntu-latest
    
    steps:
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        
      - name: Compare Results
        run: |
          echo "=== Comparison Summary ==="
          echo ""
          
          echo "Security Scan:"
          if [ -f "security-scan-report/scan-report.json" ]; then
            jq '.statistics' security-scan-report/scan-report.json
          fi
          
          echo ""
          echo "Quality Scan:"
          if [ -f "quality-scan-report/scan-report.json" ]; then
            jq '.statistics' quality-scan-report/scan-report.json
          fi
          
          echo ""
          echo "Documentation:"
          if [ -d "full-documentation" ]; then
            find full-documentation -name "*.md" | wc -l
            echo "documentation sections generated"
          fi
          
      - name: Generate Comparison Report
        run: |
          cat > comparison-report.md << 'EOF'
          # Code Sentinel AI - Test Results Comparison
          
          ## Test Run: $(date)
          
          ### Security Scan
          - Files Analyzed: $(jq -r '.metadata.filesAnalyzed // "N/A"' security-scan-report/scan-report.json 2>/dev/null || echo "N/A")
          - Critical Issues: $(jq -r '.statistics.criticalIssues // 0' security-scan-report/scan-report.json 2>/dev/null || echo "0")
          - High Issues: $(jq -r '.statistics.highIssues // 0' security-scan-report/scan-report.json 2>/dev/null || echo "0")
          
          ### Quality Scan
          - Files Analyzed: $(jq -r '.metadata.filesAnalyzed // "N/A"' quality-scan-report/scan-report.json 2>/dev/null || echo "N/A")
          - Code Quality Score: $(jq -r '.statistics.qualityScore // "N/A"' quality-scan-report/scan-report.json 2>/dev/null || echo "N/A")
          
          ### Documentation Generation
          - Sections Generated: $(find full-documentation -name "*.md" 2>/dev/null | wc -l || echo "0")
          - Total Words: $(find full-documentation -name "*.md" -exec wc -w {} + 2>/dev/null | tail -1 | awk '{print $1}' || echo "0")
          
          ## Conclusion
          All modes tested successfully!
          EOF
          
          cat comparison-report.md
          
      - name: Upload Comparison Report
        uses: actions/upload-artifact@v4
        with:
          name: comparison-report
          path: comparison-report.md

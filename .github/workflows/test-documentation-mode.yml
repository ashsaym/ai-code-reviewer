name: Test Documentation Mode

on:
  workflow_dispatch:
    inputs:
      documentation-scope:
        description: 'Documentation scope'
        required: false
        default: 'full'
        type: choice
        options:
          - full
          - api-only
          - user-guide
      documentation-formats:
        description: 'Output formats (comma-separated)'
        required: false
        default: 'markdown,html'
        type: string

jobs:
  test-documentation:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Install dependencies
        run: |
          cd code-sentinel-ai
          npm ci
          
      - name: Build action
        run: |
          cd code-sentinel-ai
          npm run build
          
      - name: Run Documentation Mode
        id: documentation
        uses: ./code-sentinel-ai
        with:
          mode: 'documentation'
          documentation-scope: ${{ inputs.documentation-scope }}
          documentation-formats: ${{ inputs.documentation-formats }}
          documentation-output-dir: './docs-generated'
          github-token: ${{ secrets.GITHUB_TOKEN }}
          api-key: ${{ secrets.OPENAI_API_KEY }}
          provider: 'openai'
          model: 'gpt-4o'
          
      - name: Display Documentation Structure
        if: always()
        run: |
          echo "=== Generated Documentation ==="
          if [ -d "docs-generated" ]; then
            find docs-generated -type f -name "*.md" -o -name "*.html" | head -20
            echo ""
            echo "=== Documentation Files Count ==="
            find docs-generated -type f | wc -l
          else
            echo "No documentation directory found"
          fi
          
      - name: Preview Documentation Content
        if: always()
        run: |
          echo "=== Documentation Preview ==="
          if [ -f "docs-generated/README.md" ]; then
            head -50 docs-generated/README.md
          elif [ -f "docs-generated/index.md" ]; then
            head -50 docs-generated/index.md
          else
            echo "No main documentation file found"
            ls -la docs-generated/ 2>/dev/null || echo "Directory not found"
          fi
          
      - name: Upload Documentation
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: generated-documentation-${{ inputs.documentation-scope }}
          path: docs-generated/
          retention-days: 30
          
      - name: Validate Documentation Quality
        if: always()
        run: |
          echo "=== Documentation Quality Check ==="
          TOTAL_WORDS=0
          TOTAL_SECTIONS=0
          
          if [ -d "docs-generated" ]; then
            for file in docs-generated/*.md; do
              if [ -f "$file" ]; then
                WORDS=$(wc -w < "$file")
                TOTAL_WORDS=$((TOTAL_WORDS + WORDS))
                echo "$(basename $file): $WORDS words"
              fi
            done
            
            TOTAL_SECTIONS=$(find docs-generated -name "*.md" | wc -l)
            
            echo ""
            echo "Total Documentation Sections: $TOTAL_SECTIONS"
            echo "Total Words: $TOTAL_WORDS"
            
            if [ $TOTAL_WORDS -lt 500 ]; then
              echo "::warning::Documentation seems too short ($TOTAL_WORDS words)"
            else
              echo "::notice::Documentation looks comprehensive!"
            fi
          fi
          
      - name: Verify Action Outputs
        run: |
          echo "=== Action Outputs ==="
          echo "Success: ${{ steps.documentation.outputs.success }}"
          echo "Sections Count: ${{ steps.documentation.outputs.sections-count }}"
          echo "Words Count: ${{ steps.documentation.outputs.words-count }}"
          echo "Output Path: ${{ steps.documentation.outputs.output-path }}"
